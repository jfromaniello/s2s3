#!/usr/bin/env node

var Q       = require('q');
var fs      = require('fs');
var path    = require('path');

var exec    = Q.nfbind(require('child_process').exec);
var AWS     = require('aws-sdk');
var moment = require('moment');

var config;

//load configuration
try{
  config = JSON.parse(fs.readFileSync(path.join(process.env.HOME, '/.ss-to-s3.config')).toString());
} catch(er) {
  console.log(er);
  console.log('Mising ~/.ss-to-s3.config');
  var example = {
    "ACCESS_KEY_ID":     "MY-ACCESS-KEY",
    "ACCESS_KEY_SECRET": "MY-KEY-SECRET",
    "BUCKET":            "THE-BUCKET",
    "COPY_FORMAT":       "![{filekey}](http://THE-BUCKET.amazonaws.com/{filekey})"
  };
  console.log('example: \n ', JSON.stringify(example));
  return process.exit(1);
}
//------------------


AWS.config.update({
  accessKeyId: config.ACCESS_KEY_ID,
  secretAccessKey: config.ACCESS_KEY_SECRET
});

var s3 = new AWS.S3({params: { Bucket:  config.BUCKET}});
var file = 'ss-' + moment().format('YYYY-MM-DDTHH-mm-ss') + '.png';
var fullpath = '/tmp/' + file;

exec('screencapture -i ' + fullpath)
  .then(function () {
    if (config.PREVIEW_BEFORE_UPLOAD) {
      return exec('open -W -F -a Preview ' + fullpath);
    } else {
      return file;
    }
  })
  .then(function () {
    var key = file;
    var result = config.COPY_FORMAT.replace(/\{filekey\}/ig, key);
    return exec('echo "' + result  + '" | pbcopy')
          .thenResolve([fullpath, key]);
  })
  .spread(function (file, key) {
    return Q.ninvoke(s3, 'putObject', {
      Key:         key,
      Body:        fs.readFileSync(file),
      ContentType: 'image/png'
    })
    .then(function(){
      fs.unlinkSync(file);
    })
    .thenResolve(key);
  })
  .then(null, function (err) {
    console.log(err);
  });